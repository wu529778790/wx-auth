# å¾®ä¿¡è®¢é˜…å·è®¤è¯ç³»ç»Ÿ - Nuxt 4 æç®€ç‰ˆ

> ğŸ¯ **æç®€è®¾è®¡ï¼Œæ— éœ€æ•°æ®åº“ï¼Œå¼€ç®±å³ç”¨**

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Nuxt 4** çš„å¾®ä¿¡è®¢é˜…å·è®¤è¯ç³»ç»Ÿï¼Œ**å…³æ³¨å…¬ä¼—å·è‡ªåŠ¨å‘é€éªŒè¯ç **ï¼Œç”¨æˆ·è¾“å…¥éªŒè¯ç å®Œæˆè®¤è¯ã€‚**å®Œå…¨ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œæ— éœ€é…ç½®æ•°æ®åº“**ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- âœ… **é›¶æ•°æ®åº“** - çº¯å†…å­˜å­˜å‚¨ï¼Œéƒ¨ç½²æ›´ç®€å•
- âœ… **è‡ªåŠ¨å‘é€** - å…³æ³¨å…¬ä¼—å·ç«‹å³æ”¶åˆ°éªŒè¯ç 
- âœ… **å•é¡µé¢** - æ— éœ€é¢å¤–é¡µé¢ï¼Œä½“éªŒæ›´æµç•…
- âœ… **è‡ªåŠ¨æ¸…ç†** - è¿‡æœŸæ•°æ®è‡ªåŠ¨åˆ é™¤

## ğŸ“‹ å·¥ä½œæµç¨‹ï¼ˆæ­£ç¡®æµç¨‹ï¼‰

```
ç”¨æˆ·è®¿é—®ç½‘ç«™
    â†“
æ˜¾ç¤ºå¼•å¯¼é¡µï¼ˆäºŒç»´ç  + è¾“å…¥æ¡†ï¼‰
    â†“
ç”¨æˆ·æ‰«ç å…³æ³¨å…¬ä¼—å·
    â†“
å…¬ä¼—å·è‡ªåŠ¨å‘é€6ä½éªŒè¯ç 
    â†“
ç”¨æˆ·åœ¨ç½‘ç«™è¾“å…¥éªŒè¯ç 
    â†“
éªŒè¯æˆåŠŸ â†’ å®Œæˆç™»å½•
```

**æµç¨‹è¯´æ˜ï¼š**
1. ç”¨æˆ·è®¿é—®ç½‘ç«™ï¼Œçœ‹åˆ°å¼•å¯¼é¡µé¢
2. æ‰«ç å…³æ³¨å…¬ä¼—å·
3. **å…¬ä¼—å·è‡ªåŠ¨å‘é€éªŒè¯ç **ï¼ˆå¦‚ï¼š`æ‚¨çš„è®¤è¯ç ï¼š123456`ï¼‰
4. ç”¨æˆ·åœ¨ç½‘ç«™è¾“å…¥ `123456`
5. ç‚¹å‡»"éªŒè¯"æŒ‰é’®ï¼Œå®Œæˆç™»å½•

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pnpm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
# ç½‘ç«™åœ°å€ï¼ˆå¿…é¡»ï¼‰
SITE_URL=https://your-website.com

# æœåŠ¡å™¨ Tokenï¼ˆå¿…é¡»ï¼Œä¸å¾®ä¿¡åå°ä¸€è‡´ï¼‰
WECHAT_TOKEN=your-wechat-token

# Sessionå¯†é’¥ï¼ˆå¿…é¡»ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨éšæœºå­—ç¬¦ä¸²ï¼‰
SESSION_SECRET=openssl rand -hex 32

# ä»¥ä¸‹å¯é€‰ï¼ˆæœªè®¤è¯è®¢é˜…å·æ— éœ€å¡«å†™ï¼‰
WECHAT_APPID=
WECHAT_APPSECRET=
```

### 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
pnpm dev
```

è®¿é—® http://localhost:3000

### 4. é…ç½®å¾®ä¿¡å…¬ä¼—å·åå°

ç™»å½•å¾®ä¿¡å…¬ä¼—å·å¹³å° â†’ å¼€å‘ â†’ åŸºæœ¬é…ç½®ï¼š

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| **æœåŠ¡å™¨URL** | `https://your-domain.com/api/wechat/message` |
| **Token** | ä¸ `.env` ä¸­çš„ `WECHAT_TOKEN` ä¸€è‡´ |
| **EncodingAESKey** | éšæœºç”Ÿæˆæˆ–ç•™ç©º |
| **æ¶ˆæ¯åŠ è§£å¯†æ–¹å¼** | æ¨è **æ˜æ–‡æ¨¡å¼** |

### 5. æµ‹è¯•å®Œæ•´æµç¨‹

1. **è®¿é—®ç½‘ç«™** â†’ çœ‹åˆ°å¼•å¯¼é¡µé¢
2. **æ‰«ç å…³æ³¨** ä½ çš„å…¬ä¼—å·
3. **æ”¶åˆ°æ¶ˆæ¯**ï¼šå…¬ä¼—å·è‡ªåŠ¨å‘é€éªŒè¯ç ï¼ˆå¦‚ï¼š`æ‚¨çš„è®¤è¯ç ï¼š123456`ï¼‰
4. **è¾“å…¥éªŒè¯ç **ï¼šåœ¨ç½‘ç«™è¾“å…¥ `123456`
5. **ç‚¹å‡»éªŒè¯**ï¼šå®Œæˆç™»å½•

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

### ç›®å½•ç»“æ„

```
wechat-subscription-auth/
â”œâ”€â”€ server/                      # æœåŠ¡ç«¯ä»£ç 
â”‚   â”œâ”€â”€ api/                     # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ wechat/
â”‚   â”‚   â”‚   â””â”€â”€ message.ts      # å¾®ä¿¡æ¶ˆæ¯å¤„ç†ï¼ˆå…³æ³¨æ—¶å‘éªŒè¯ç ï¼‰
â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚       â”œâ”€â”€ check.ts        # éªŒè¯ç æ£€æŸ¥
â”‚   â”‚       â””â”€â”€ session.ts      # Session ç®¡ç†
â”‚   â””â”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ storage.ts          # å†…å­˜å­˜å‚¨
â”‚       â”œâ”€â”€ wechat.ts           # å¾®ä¿¡å·¥å…·
â”‚       â””â”€â”€ session.ts          # Session å·¥å…·
â”œâ”€â”€ pages/                       # å‰ç«¯é¡µé¢
â”‚   â””â”€â”€ index.vue               # å•é¡µè®¤è¯ï¼ˆè¾“å…¥éªŒè¯ç ï¼‰
â”œâ”€â”€ app.vue                     # æ ¹ç»„ä»¶
â”œâ”€â”€ nuxt.config.ts              # Nuxt é…ç½®
â””â”€â”€ package.json                # ä¾èµ–
```

### æ ¸å¿ƒé€»è¾‘

#### 1. å¾®ä¿¡æ¶ˆæ¯å¤„ç† (`server/api/wechat/message.ts`)
```typescript
// ç”¨æˆ·å…³æ³¨å…¬ä¼—å·æ—¶
if (MsgType === 'event' && Event === 'subscribe') {
  // ç”Ÿæˆ6ä½éªŒè¯ç 
  const code = generateVerificationCode();

  // ä¿å­˜éªŒè¯ç 
  saveAuthCode(code, FromUserName);

  // è‡ªåŠ¨å›å¤éªŒè¯ç 
  return reply(`æ‚¨çš„è®¤è¯ç ï¼š${code}`);
}
```

#### 2. å‰ç«¯éªŒè¯ (`pages/index.vue`)
```typescript
// ç”¨æˆ·è¾“å…¥éªŒè¯ç 
const verifyCode = async () => {
  const result = await $fetch('/api/auth/check', {
    query: { authToken: verificationCode.value }
  });

  if (result.authenticated) {
    // ç™»å½•æˆåŠŸ
    session.value = result;
    // ä¿å­˜cookie
    document.cookie = `wxauth-openid=${result.user.openid}; ...`;
  }
};
```

## ğŸ”§ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Nuxt** | 4.0+ | æœåŠ¡ç«¯æ¸²æŸ“æ¡†æ¶ |
| **H3** | 1.13+ | HTTP æœåŠ¡å™¨ |
| **fast-xml-parser** | 4.4+ | XML æ¶ˆæ¯è§£æ |
| **Tailwind CSS** | 3.4+ | æ ·å¼æ¡†æ¶ |
| **TypeScript** | 5.2+ | ç±»å‹å®‰å…¨ |

## ğŸ¨ UI ç‰¹æ€§

### ä¸»é¡µ (`pages/index.vue`)
- âœ… æ¸…æ™°çš„3æ­¥æ“ä½œæŒ‡å¼•
- âœ… å¤§å·éªŒè¯ç è¾“å…¥æ¡†
- âœ… å®æ—¶çŠ¶æ€æç¤ºï¼ˆæˆåŠŸ/é”™è¯¯/ç­‰å¾…ï¼‰
- âœ… éªŒè¯æŒ‰é’®ï¼ˆå¸¦ç¦ç”¨çŠ¶æ€ï¼‰
- âœ… é‡æ–°è·å–éªŒè¯ç æç¤º
- âœ… å“åº”å¼è®¾è®¡

## ğŸš€ éƒ¨ç½²æŒ‡å—

### åœºæ™¯ 1: éƒ¨ç½²åˆ° Vercelï¼ˆæ¨è - å…è´¹ï¼‰

```bash
# 1. å®‰è£… Vercel CLI
npm i -g vercel

# 2. éƒ¨ç½²
pnpm build
vercel --prod
```

**Vercel ç¯å¢ƒå˜é‡é…ç½®ï¼š**
ç™»å½• Vercel æ§åˆ¶å° â†’ é€‰æ‹©é¡¹ç›® â†’ Settings â†’ Environment Variables

| å˜é‡å | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `SITE_URL` | `https://your-main-site.com` | ä½ çš„åŸŸå |
| `WECHAT_TOKEN` | `ä½ çš„Token` | ä¸å¾®ä¿¡åå°ä¸€è‡´ |
| `SESSION_SECRET` | `openssl rand -hex 32` ç”Ÿæˆçš„éšæœºå€¼ | åŠ å¯†å¯†é’¥ |

### åœºæ™¯ 2: éƒ¨ç½²åˆ°è‡ªæœ‰æœåŠ¡å™¨ï¼ˆVPS/äº‘æœåŠ¡å™¨ï¼‰

```bash
# 1. å…‹éš†ä»£ç 
git clone https://github.com/wu529778790/wechat-subscription-auth.git
cd wechat-subscription-auth

# 2. å®‰è£…ä¾èµ–
pnpm install

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .envï¼Œå¡«å…¥ä½ çš„é…ç½®

# 4. æ„å»ºå¹¶è¿è¡Œ
pnpm build
pnpm preview

# 5. ä½¿ç”¨ PM2 å®ˆæŠ¤è¿›ç¨‹ï¼ˆæ¨èï¼‰
npm install -g pm2
pm2 start ecosystem.config.js
```

**PM2 é…ç½®æ–‡ä»¶ `ecosystem.config.js`ï¼š**
```javascript
module.exports = {
  apps: [{
    name: 'wechat-auth',
    script: '.output/server/index.mjs',
    env: {
      NODE_ENV: 'production',
      SITE_URL: 'https://your-main-site.com',
      WECHAT_TOKEN: 'your-token',
      SESSION_SECRET: 'your-secret'
    }
  }]
}
```

### åœºæ™¯ 3: Docker éƒ¨ç½²

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install --frozen-lockfile
COPY . .
RUN pnpm build
EXPOSE 3000
ENV NODE_ENV=production
CMD ["pnpm", "preview"]
```

æ„å»ºå¹¶è¿è¡Œï¼š
```bash
docker build -t wechat-auth .
docker run -d -p 3000:3000 \
  -e SITE_URL=https://your-main-site.com \
  -e WECHAT_TOKEN=your-token \
  -e SESSION_SECRET=your-secret \
  wechat-auth
```

### åœºæ™¯ 4: ä¸ç°æœ‰ç½‘ç«™é›†æˆ

å¦‚æœä½ çš„ `your-main-site.com` å·²æœ‰å…¶ä»–æœåŠ¡ï¼Œå¯ä»¥ï¼š

**æ–¹æ¡ˆ A: ä½œä¸ºå­è·¯å¾„**
```
https://your-main-site.com/auth  # è®¤è¯ç³»ç»Ÿ
```
ä¿®æ”¹ `nuxt.config.ts`ï¼š
```typescript
export default defineNuxtConfig({
  app: {
    baseURL: '/auth/'
  }
})
```

**æ–¹æ¡ˆ B: ä½œä¸ºå­åŸŸåï¼ˆæ¨èï¼‰**
```
https://your-domain.com  # è®¤è¯ç³»ç»Ÿ
https://your-main-site.com  # ä¸»ç½‘ç«™
```
éƒ¨ç½²æ—¶é…ç½® `SITE_URL=https://your-domain.com`

**æ–¹æ¡ˆ C: åµŒå…¥ç°æœ‰ç½‘ç«™**
åœ¨ä½ çš„åšå®¢ä¸­æ·»åŠ ä¸€ä¸ªé¡µé¢ï¼ŒåµŒå…¥è®¤è¯ç³»ç»Ÿçš„ iframe æˆ–è·³è½¬ã€‚

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä½¿ç”¨å¼ºéšæœº Session å¯†é’¥**
   ```bash
   openssl rand -hex 32
   ```

2. **å¯ç”¨ HTTPS**ï¼ˆå¾®ä¿¡å¼ºåˆ¶è¦æ±‚ï¼‰

3. **ä¿æŠ¤æ•æ„Ÿä¿¡æ¯**
   - ä¸è¦æäº¤ `.env` æ–‡ä»¶
   - `WECHAT_TOKEN` ä¿å¯†

4. **éªŒè¯ç æœ‰æ•ˆæœŸ**
   - é»˜è®¤5åˆ†é’Ÿï¼Œå¯è°ƒæ•´
   - è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®

## âš ï¸ æ³¨æ„äº‹é¡¹

### å†…å­˜å­˜å‚¨çš„é™åˆ¶

- **é‡å¯åæ•°æ®ä¸¢å¤±** - é€‚åˆå¼€å‘å’Œå°å‹é¡¹ç›®
- **å•å®ä¾‹é™åˆ¶** - å¤šæœåŠ¡å™¨éƒ¨ç½²éœ€è¦å…±äº«å­˜å‚¨
- **ç”Ÿäº§ç¯å¢ƒå»ºè®®** - å¦‚éœ€æŒä¹…åŒ–ï¼Œå¯æ·»åŠ  Redis æˆ–æ•°æ®åº“

### å¦‚ä½•æ”¹ä¸ºæŒä¹…åŒ–å­˜å‚¨ï¼Ÿ

åªéœ€ä¿®æ”¹ `server/utils/storage.ts`ï¼š

```typescript
// ä½¿ç”¨ Redis
import redis from 'redis';

export async function saveAuthCode(code, openid) {
  await redis.setex(`auth:${code}`, 300, JSON.stringify({ openid }));
}
```

## ğŸ› å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| æ¶ˆæ¯æœªå›å¤ | æœåŠ¡å™¨URLä¸å¯è®¿é—® | æ£€æŸ¥HTTPSã€åŸŸåè§£æã€é˜²ç«å¢™ |
| éªŒè¯ç æ— æ•ˆ | Tokenè¿‡æœŸ | å»¶é•¿æœ‰æ•ˆæœŸæˆ–é‡æ–°è·å– |
| éªŒè¯å¤±è´¥ | Cookieé—®é¢˜ | æ£€æŸ¥æµè§ˆå™¨Cookieè®¾ç½® |
| éƒ¨ç½²å¤±è´¥ | ä¾èµ–é—®é¢˜ | åˆ é™¤node_modulesé‡æ–°å®‰è£… |

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

- âœ… **è½»é‡çº§**ï¼šæ— æ•°æ®åº“ä¾èµ–
- âœ… **å¿«é€Ÿå“åº”**ï¼šå†…å­˜å­˜å‚¨ï¼Œæ¯«ç§’çº§æŸ¥è¯¢
- âœ… **ä½èµ„æºæ¶ˆè€—**ï¼šé€‚åˆå°å‹é¡¹ç›®
- âœ… **è‡ªåŠ¨æ¸…ç†**ï¼šé¿å…å†…å­˜æ³„æ¼

## ğŸ¯ ä¸æ—§ç‰ˆå¯¹æ¯”

| ç‰¹æ€§ | æ—§ç‰ˆ (è‡ªåŠ¨è½®è¯¢) | æ–°ç‰ˆ (æ­£ç¡®æµç¨‹) |
|------|----------------|----------------|
| **æµç¨‹** | è®¿é—®â†’è½®è¯¢â†’è‡ªåŠ¨ç™»å½• | è®¿é—®â†’å…³æ³¨â†’æ”¶éªŒè¯ç â†’è¾“å…¥â†’ç™»å½• |
| **ç”¨æˆ·ä½“éªŒ** | éœ€è¦ç­‰å¾… | ä¸»åŠ¨è¾“å…¥ï¼Œæ›´ç›´è§‚ |
| **æœåŠ¡å™¨å‹åŠ›** | æ¯3ç§’è½®è¯¢ | åªåœ¨éªŒè¯æ—¶è¯·æ±‚ |
| **ä»£ç å¤æ‚åº¦** | éœ€è¦auth.vue | å•é¡µå®Œæˆ |
| **é€‚åˆè®¢é˜…å·** | âŒ éœ€è¦AppSecret | âœ… åªéœ€Token |

## ğŸ“„ è®¸å¯è¯

MIT License - ä½ å¯ä»¥è‡ªç”±ä½¿ç”¨ã€ä¿®æ”¹å’Œåˆ†å‘æ­¤ä»£ç ã€‚

## ğŸ’¬ é—®é¢˜åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼š
1. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
2. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
3. ç¡®è®¤å¾®ä¿¡å…¬ä¼—å·åå°é…ç½®
4. æŸ¥çœ‹ Nuxt å®˜æ–¹æ–‡æ¡£

---

**ç«‹å³å¼€å§‹ï¼š**

```bash
pnpm install
cp .env.example .env
pnpm dev
```

ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰
