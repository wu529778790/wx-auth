# 未认证订阅号使用指南

## 📋 重要说明

**未认证订阅号**无法自动接收关注事件，需要用户**手动发送关键词**触发验证码。

---

## 🎯 工作流程

### 完整流程图
```
用户访问网站
    ↓
显示认证页面（含公众号二维码）
    ↓
用户扫码关注公众号
    ↓
用户在微信中发送：验证码
    ↓
公众号自动回复：您的认证码：123456
    ↓
用户在网站输入：123456
    ↓
点击"验证"按钮
    ↓
认证成功！
```

---

## 📱 用户操作指南

### 步骤1：访问网站
用户打开您的网站，看到认证弹窗：
- 显示公众号二维码
- 显示公众号名称
- 提示"关注后发送'验证码'获取认证码"

### 步骤2：关注公众号
用户使用微信扫码 → 点击关注

### 步骤3：获取验证码
**在微信中发送以下任意关键词：**
- ✅ **验证码** （推荐）
- ✅ **已关注**
- ✅ **认证**
- ✅ **验证**
- ✅ **login**

**公众号会自动回复：**
```
欢迎！
您的认证码：123456

请在网站输入此验证码完成认证。
```

### 步骤4：完成认证
1. 在网站输入：`123456`
2. 点击"验证"按钮
3. 认证成功！

---

## 🔧 微信后台配置

### 情况1：有服务器配置权限

**配置步骤：**
1. 登录微信公众号后台
2. 进入 **基本配置** → **服务器配置**
3. 填写：
   ```
   URL: https://auth.shenzjd.com/api/wechat/message
   Token: 与 .env 中的 WECHAT_TOKEN 一致
   消息加解密方式: 明文模式
   ```
4. 点击提交并启用

**效果：**
- 用户关注时自动发送验证码
- 用户发送关键词也能收到验证码

---

### 情况2：没有服务器配置权限

**无需配置！**

您的代码已经支持关键词自动回复，用户发送关键词即可触发。

**注意：**
- 需要确保服务器正在运行
- 需要确保环境变量配置正确

---

## ⚙️ 环境变量配置

### 必须配置
```bash
# .env
SITE_URL=https://your-domain.com
SESSION_SECRET=your-secret-key
WECHAT_TOKEN=your-token
WECHAT_NAME=我的公众号
```

### 可选配置
```bash
WECHAT_QRCODE_URL=  # 二维码图片URL，留空显示默认占位图
```

---

## 🎨 前端显示优化

### 推荐的页面提示

认证页面会自动显示：
```
┌─────────────────────────────┐
│         🔐 身份认证          │
│                             │
│    ┌───────────────────┐    │
│    │  [二维码图片]      │    │
│    │  微信扫码关注      │    │
│    │  或搜索公众号: xxx │    │
│    └───────────────────┘    │
│                             │
│    输入6位验证码             │
│    ┌───────────┐ ┌──────┐  │
│    │           │ │ 验证 │  │
│    └───────────┘ └──────┘  │
│                             │
│  💡 关注后发送"验证码"获取   │
└─────────────────────────────┘
```

---

## 🔍 故障排查

### ❌ 用户关注后没收到回复

**可能原因：**

1. **服务器未运行**
   ```bash
   # 检查服务器状态
   curl https://auth.shenzjd.com/api/wechat/message
   ```

2. **Token不匹配**
   ```bash
   # 检查 .env 中的 WECHAT_TOKEN
   # 必须与微信后台配置一致（如果有配置）
   ```

3. **关键词不匹配**
   - 确保用户发送的是：**验证码**、**已关注**、**认证** 等关键词
   - 可以在微信中发送"帮助"查看支持的关键词

4. **查看日志**
   ```bash
   # Vercel用户：查看控制台日志
   # 本地开发：查看终端输出
   ```

### ✅ 如何测试

1. **测试关注流程**
   ```
   取消关注 → 重新关注 → 发送"验证码"
   ```

2. **测试关键词**
   ```
   发送：验证码
   预期：收到6位数字验证码
   ```

3. **测试网站验证**
   ```
   输入收到的验证码 → 点击验证 → 应该显示认证成功
   ```

---

## 📊 认证服务号 vs 订阅号

| 功能 | 未认证订阅号 | 认证服务号 |
|------|-------------|-----------|
| **自动发送验证码** | ❌ 需要用户手动触发 | ✅ 关注自动发送 |
| **服务器配置** | ❌ 可能没有 | ✅ 有 |
| **模板消息** | ❌ 不支持 | ✅ 支持 |
| **自定义菜单** | ❌ 有限制 | ✅ 完全支持 |
| **成本** | 免费 | 300元/年 |

---

## 💡 使用建议

### 对于未认证订阅号

1. **在网站上明确提示用户**
   ```
   关注公众号后，请在微信中发送"验证码"获取认证码
   ```

2. **使用清晰的关键词**
   - 推荐：**验证码**（最直观）
   - 备选：**已关注**、**认证**

3. **提供帮助信息**
   - 用户发送"帮助"时，返回使用说明
   - 用户发送"状态"时，返回认证状态

4. **考虑升级服务号**
   - 如果用户量大，建议升级认证服务号
   - 体验更好，功能更完整

---

## 🚀 快速开始

### 1. 配置环境变量
```bash
cp .env.example .env
# 编辑 .env，填写：
# - SITE_URL
# - SESSION_SECRET
# - WECHAT_TOKEN
# - WECHAT_NAME
```

### 2. 启动服务器
```bash
pnpm install
pnpm dev
```

### 3. 测试流程
```
1. 访问 http://localhost:3000
2. 扫码关注公众号
3. 在微信发送"验证码"
4. 收到验证码
5. 在网站输入验证码
6. 认证成功！
```

---

## 📞 需要帮助？

如果仍有问题，请检查：

1. **服务器是否正常运行？**
   ```bash
   curl https://auth.shenzjd.com/api/wechat/message
   ```

2. **环境变量是否正确？**
   ```bash
   echo $WECHAT_TOKEN
   echo $WECHAT_NAME
   ```

3. **查看实时日志**
   - Vercel: 控制台 → Functions → 日志
   - 本地: 终端输出

---

**未认证订阅号完全可以使用！只是需要用户多一步操作：手动发送关键词触发验证码。** ✅
